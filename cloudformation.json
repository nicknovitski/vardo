{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "yeee",
  "Parameters": {
    "InstanceType": {
      "Description": "EC2 instance type",
      "Type": "String",
      "Default": "t2.medium",
      "AllowedValues": [
        "t2.small",
        "t2.medium",
      ],
      "ConstraintDescription": "must be a valid EC2 instance type."
    },
    "KeyName": {
      "Description": "Name of an existing EC2 KeyPair to enable SSH access to the instance",
      "Type": "AWS::EC2::KeyPair::KeyName",
      "ConstraintDescription": "must be the name of an existing EC2 KeyPair."
    },
    "SSHLocation": {
      "Description": " The IP address range that can be used to SSH to the EC2 instances",
      "Type": "String",
      "MinLength": "9",
      "MaxLength": "18",
      "Default": "0.0.0.0/0",
      "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
      "ConstraintDescription": "must be a valid IP CIDR range of the form x.x.x.x/x."
    }
  },
  "Resources": {
    "VPC": {
      "Type": "AWS::EC2::VPC",
      "Properties": {
        "CidrBlock": "10.0.0.0/16",
        "Tags": [
          {
            "Key": "Application",
            "Value": {
              "Ref": "AWS::StackId"
            }
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "c3b9f586-15d2-4534-ab1f-71f554d4f45c"
        }
      }
    },
    "Subnet": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": {
          "Ref": "VPC"
        },
        "CidrBlock": "10.0.0.0/24",
        "Tags": [
          {
            "Key": "Application",
            "Value": {
              "Ref": "AWS::StackId"
            }
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "a03221d0-f68c-4b8d-80da-f21a49201aa3"
        }
      }
    },
    "InternetGateway": {
      "Type": "AWS::EC2::InternetGateway",
      "Properties": {
        "Tags": [
          {
            "Key": "Application",
            "Value": {
              "Ref": "AWS::StackId"
            }
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "2fd5d952-9d65-4158-b3b6-875eb97ed27b"
        }
      }
    },
    "AttachGateway": {
      "Type": "AWS::EC2::VPCGatewayAttachment",
      "Properties": {
        "VpcId": {
          "Ref": "VPC"
        },
        "InternetGatewayId": {
          "Ref": "InternetGateway"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "d7bfd480-0b6d-4f91-b03b-b8b9d2a8490a"
        }
      }
    },
    "RouteTable": {
      "Type": "AWS::EC2::RouteTable",
      "Properties": {
        "VpcId": {
          "Ref": "VPC"
        },
        "Tags": [
          {
            "Key": "Application",
            "Value": {
              "Ref": "AWS::StackId"
            }
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "b91b7044-eb33-403c-a250-d4ed2a56dd94"
        }
      }
    },
    "Route": {
      "Type": "AWS::EC2::Route",
      "DependsOn": "AttachGateway",
      "Properties": {
        "RouteTableId": {
          "Ref": "RouteTable"
        },
        "DestinationCidrBlock": "0.0.0.0/0",
        "GatewayId": {
          "Ref": "InternetGateway"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "f3b59177-d781-4217-b5a6-bcd256a092e6"
        }
      }
    },
    "SubnetRouteTableAssociation": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "SubnetId": {
          "Ref": "Subnet"
        },
        "RouteTableId": {
          "Ref": "RouteTable"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "80d3705b-398c-43a4-8c51-15a5242d41b4"
        }
      }
    },
    "NetworkAcl": {
      "Type": "AWS::EC2::NetworkAcl",
      "Properties": {
        "VpcId": {
          "Ref": "VPC"
        },
        "Tags": [
          {
            "Key": "Application",
            "Value": {
              "Ref": "AWS::StackId"
            }
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "85fc77c5-4024-4568-b410-f5e54d28c01b"
        }
      }
    },
    "InboundHTTPNetworkAclEntry": {
      "Type": "AWS::EC2::NetworkAclEntry",
      "Properties": {
        "NetworkAclId": {
          "Ref": "NetworkAcl"
        },
        "RuleNumber": "100",
        "Protocol": "6",
        "RuleAction": "allow",
        "Egress": "false",
        "CidrBlock": "0.0.0.0/0",
        "PortRange": {
          "From": "80",
          "To": "80"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "f4489e46-5a0b-43d8-9580-a35787582d85"
        }
      }
    },
    "InboundSSHNetworkAclEntry": {
      "Type": "AWS::EC2::NetworkAclEntry",
      "Properties": {
        "NetworkAclId": {
          "Ref": "NetworkAcl"
        },
        "RuleNumber": "101",
        "Protocol": "6",
        "RuleAction": "allow",
        "Egress": "false",
        "CidrBlock": "0.0.0.0/0",
        "PortRange": {
          "From": "22",
          "To": "22"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "f9c483a8-8e19-491c-90f9-4050e9313dbc"
        }
      }
    },
    "InboundTCPPortsNetworkAclEntry": {
      "Type": "AWS::EC2::NetworkAclEntry",
      "Properties": {
        "NetworkAclId": {
          "Ref": "NetworkAcl"
        },
        "RuleNumber": "102",
        "Protocol": "6",
        "RuleAction": "allow",
        "Egress": "false",
        "CidrBlock": "0.0.0.0/0",
        "PortRange": {
          "From": "1024",
          "To": "65535"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "728707ad-f78e-452c-bbdb-572933eb648b"
        }
      }
    },
    "InboundUDPPortsNetworkAclEntry": {
      "Type": "AWS::EC2::NetworkAclEntry",
      "Properties": {
        "NetworkAclId": {
          "Ref": "NetworkAcl"
        },
        "RuleNumber": "102",
        "Protocol": "17",
        "RuleAction": "allow",
        "Egress": "false",
        "CidrBlock": "0.0.0.0/0",
        "PortRange": {
          "From": "1024",
          "To": "65535"
        }
      }
    },
    "OutBoundHTTPNetworkAclEntry": {
      "Type": "AWS::EC2::NetworkAclEntry",
      "Properties": {
        "NetworkAclId": {
          "Ref": "NetworkAcl"
        },
        "RuleNumber": "100",
        "Protocol": "6",
        "RuleAction": "allow",
        "Egress": "true",
        "CidrBlock": "0.0.0.0/0",
        "PortRange": {
          "From": "80",
          "To": "80"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "5657d78c-5307-4c42-9cf0-589a946146fa"
        }
      }
    },
    "OutBoundHTTPSNetworkAclEntry": {
      "Type": "AWS::EC2::NetworkAclEntry",
      "Properties": {
        "NetworkAclId": {
          "Ref": "NetworkAcl"
        },
        "RuleNumber": "101",
        "Protocol": "6",
        "RuleAction": "allow",
        "Egress": "true",
        "CidrBlock": "0.0.0.0/0",
        "PortRange": {
          "From": "443",
          "To": "443"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "bb77b0e6-a2aa-4af5-89c2-829b18f4231a"
        }
      }
    },
    "OutBoundResponsePortsNetworkAclEntry": {
      "Type": "AWS::EC2::NetworkAclEntry",
      "Properties": {
        "NetworkAclId": {
          "Ref": "NetworkAcl"
        },
        "RuleNumber": "102",
        "Protocol": "6",
        "RuleAction": "allow",
        "Egress": "true",
        "CidrBlock": "0.0.0.0/0",
        "PortRange": {
          "From": "1024",
          "To": "65535"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "40d4fb2f-a7fc-4b4f-a8d3-10b555a13857"
        }
      }
    },
    "SubnetNetworkAclAssociation": {
      "Type": "AWS::EC2::SubnetNetworkAclAssociation",
      "Properties": {
        "SubnetId": {
          "Ref": "Subnet"
        },
        "NetworkAclId": {
          "Ref": "NetworkAcl"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "adc1fe1d-0dfc-4dbc-8af1-28bbff3d2827"
        }
      }
    },
    "IPAddress": {
      "Type": "AWS::EC2::EIP",
      "DependsOn": "AttachGateway",
      "Properties": {
        "Domain": "vpc",
        "InstanceId": {
          "Ref": "WebServerInstance"
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "fbee4fe9-ea2d-4e6e-b537-753c24e29cd5"
        }
      }
    },
    "InstanceSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "VpcId": {
          "Ref": "VPC"
        },
        "GroupDescription": "Enable SSH access via port 22",
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "22",
            "ToPort": "22",
            "CidrIp": {
              "Ref": "SSHLocation"
            }
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "80",
            "ToPort": "80",
            "CidrIp": "0.0.0.0/0"
          }
        ]
      },
      "Metadata": {
        "AWS::CloudFormation::Designer": {
          "id": "eced61b2-b313-4f15-bbd8-f8a5ce15aaf1"
        }
      }
    },
    "WebServerInstance": {
      "Type": "AWS::EC2::Instance",
      "DependsOn": "AttachGateway",
      "Metadata": {
        "Comment": "Install a simple application",
        "AWS::CloudFormation::Init": {
          "config": {
            "packages": {
              "yum": {
                "httpd": []
              }
            },
            "files": {
              "/var/www/html/index.html": {
                "content": {
                  "Fn::Join": [
                    "\n",
                    [
                      "<img src=\"",
                      {
                        "Fn::FindInMap": [
                          "Region2Examples",
                          {
                            "Ref": "AWS::Region"
                          },
                          "Examples"
                        ]
                      },
                      "/cloudformation_graphic.png\" alt=\"AWS CloudFormation Logo\"/>",
                      "<h1>Congratulations, you have successfully launched the AWS CloudFormation sample.</h1>"
                    ]
                  ]
                },
                "mode": "000644",
                "owner": "root",
                "group": "root"
              },
              "/etc/cfn/cfn-hup.conf": {
                "content": {
                  "Fn::Join": [
                    "",
                    [
                      "[main]\n",
                      "stack=",
                      {
                        "Ref": "AWS::StackId"
                      },
                      "\n",
                      "region=",
                      {
                        "Ref": "AWS::Region"
                      },
                      "\n"
                    ]
                  ]
                },
                "mode": "000400",
                "owner": "root",
                "group": "root"
              },
              "/etc/cfn/hooks.d/cfn-auto-reloader.conf": {
                "content": {
                  "Fn::Join": [
                    "",
                    [
                      "[cfn-auto-reloader-hook]\n",
                      "triggers=post.update\n",
                      "path=Resources.WebServerInstance.Metadata.AWS::CloudFormation::Init\n",
                      "action=/opt/aws/bin/cfn-init -v ",
                      "         --stack ",
                      {
                        "Ref": "AWS::StackName"
                      },
                      "         --resource WebServerInstance ",
                      "         --region ",
                      {
                        "Ref": "AWS::Region"
                      },
                      "\n",
                      "runas=root\n"
                    ]
                  ]
                }
              }
            },
            "services": {
              "sysvinit": {
                "httpd": {
                  "enabled": "true",
                  "ensureRunning": "true"
                },
                "cfn-hup": {
                  "enabled": "true",
                  "ensureRunning": "true",
                  "files": [
                    "/etc/cfn/cfn-hup.conf",
                    "/etc/cfn/hooks.d/cfn-auto-reloader.conf"
                  ]
                }
              }
            }
          }
        },
        "AWS::CloudFormation::Designer": {
          "id": "667898d4-359b-44ea-838a-08a339176711"
        }
      },
      "Properties": {
        "ImageId": {
          "Fn::FindInMap": [
            "AWSRegionArch2AMI",
            {
              "Ref": "AWS::Region"
            },
            {
              "Fn::FindInMap": [
                "AWSInstanceType2Arch",
                {
                  "Ref": "InstanceType"
                },
                "Arch"
              ]
            }
          ]
        },
        "InstanceType": {
          "Ref": "InstanceType"
        },
        "KeyName": {
          "Ref": "KeyName"
        },
        "Tags": [
          {
            "Key": "Application",
            "Value": {
              "Ref": "AWS::StackId"
            }
          }
        ],
        "NetworkInterfaces": [
          {
            "GroupSet": [
              {
                "Ref": "InstanceSecurityGroup"
              }
            ],
            "AssociatePublicIpAddress": "true",
            "DeviceIndex": "0",
            "DeleteOnTermination": "true",
            "SubnetId": {
              "Ref": "Subnet"
            }
          }
        ],
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "",
              [
                "#!/bin/bash -xe\n",
                "yum update -y aws-cfn-bootstrap\n",
                "/opt/aws/bin/cfn-init -v ",
                "         --stack ",
                {
                  "Ref": "AWS::StackName"
                },
                "         --resource WebServerInstance ",
                "         --region ",
                {
                  "Ref": "AWS::Region"
                },
                "\n",
                "/opt/aws/bin/cfn-signal -e $? ",
                "         --stack ",
                {
                  "Ref": "AWS::StackName"
                },
                "         --resource WebServerInstance ",
                "         --region ",
                {
                  "Ref": "AWS::Region"
                },
                "\n"
              ]
            ]
          }
        }
      },
      "CreationPolicy": {
        "ResourceSignal": {
          "Timeout": "PT15M"
        }
      }
    }
  },
  "Outputs": {
    "URL": {
      "Value": {
        "Fn::Join": [
          "",
          [
            "http://",
            {
              "Fn::GetAtt": [
                "WebServerInstance",
                "PublicIp"
              ]
            }
          ]
        ]
      },
      "Description": "Newly created application URL"
    }
  },
  "Metadata": {
    "AWS::CloudFormation::Designer": {
      "2fd5d952-9d65-4158-b3b6-875eb97ed27b": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 900,
          "y": 90
        },
        "z": 1,
        "embeds": []
      },
      "c3b9f586-15d2-4534-ab1f-71f554d4f45c": {
        "size": {
          "width": 780,
          "height": 780
        },
        "position": {
          "x": 60,
          "y": 90
        },
        "z": 1,
        "embeds": [
          "eced61b2-b313-4f15-bbd8-f8a5ce15aaf1",
          "85fc77c5-4024-4568-b410-f5e54d28c01b",
          "b91b7044-eb33-403c-a250-d4ed2a56dd94",
          "a03221d0-f68c-4b8d-80da-f21a49201aa3"
        ]
      },
      "eced61b2-b313-4f15-bbd8-f8a5ce15aaf1": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 570,
          "y": 150
        },
        "z": 2,
        "parent": "c3b9f586-15d2-4534-ab1f-71f554d4f45c",
        "embeds": []
      },
      "85fc77c5-4024-4568-b410-f5e54d28c01b": {
        "size": {
          "width": 420,
          "height": 330
        },
        "position": {
          "x": 90,
          "y": 150
        },
        "z": 2,
        "parent": "c3b9f586-15d2-4534-ab1f-71f554d4f45c",
        "embeds": [
          "40d4fb2f-a7fc-4b4f-a8d3-10b555a13857",
          "bb77b0e6-a2aa-4af5-89c2-829b18f4231a",
          "5657d78c-5307-4c42-9cf0-589a946146fa",
          "728707ad-f78e-452c-bbdb-572933eb648b",
          "f9c483a8-8e19-491c-90f9-4050e9313dbc",
          "f4489e46-5a0b-43d8-9580-a35787582d85"
        ]
      },
      "40d4fb2f-a7fc-4b4f-a8d3-10b555a13857": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 120,
          "y": 210
        },
        "z": 3,
        "parent": "85fc77c5-4024-4568-b410-f5e54d28c01b",
        "embeds": []
      },
      "bb77b0e6-a2aa-4af5-89c2-829b18f4231a": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 240,
          "y": 210
        },
        "z": 3,
        "parent": "85fc77c5-4024-4568-b410-f5e54d28c01b",
        "embeds": []
      },
      "5657d78c-5307-4c42-9cf0-589a946146fa": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 120,
          "y": 330
        },
        "z": 3,
        "parent": "85fc77c5-4024-4568-b410-f5e54d28c01b",
        "embeds": []
      },
      "728707ad-f78e-452c-bbdb-572933eb648b": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 240,
          "y": 330
        },
        "z": 3,
        "parent": "85fc77c5-4024-4568-b410-f5e54d28c01b",
        "embeds": []
      },
      "f9c483a8-8e19-491c-90f9-4050e9313dbc": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 360,
          "y": 210
        },
        "z": 3,
        "parent": "85fc77c5-4024-4568-b410-f5e54d28c01b",
        "embeds": []
      },
      "f4489e46-5a0b-43d8-9580-a35787582d85": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 360,
          "y": 330
        },
        "z": 3,
        "parent": "85fc77c5-4024-4568-b410-f5e54d28c01b",
        "embeds": []
      },
      "b91b7044-eb33-403c-a250-d4ed2a56dd94": {
        "size": {
          "width": 240,
          "height": 240
        },
        "position": {
          "x": 390,
          "y": 540
        },
        "z": 2,
        "parent": "c3b9f586-15d2-4534-ab1f-71f554d4f45c",
        "embeds": [
          "f3b59177-d781-4217-b5a6-bcd256a092e6"
        ]
      },
      "d7bfd480-0b6d-4f91-b03b-b8b9d2a8490a": {
        "source": {
          "id": "2fd5d952-9d65-4158-b3b6-875eb97ed27b"
        },
        "target": {
          "id": "c3b9f586-15d2-4534-ab1f-71f554d4f45c"
        }
      },
      "f3b59177-d781-4217-b5a6-bcd256a092e6": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 420,
          "y": 600
        },
        "z": 3,
        "parent": "b91b7044-eb33-403c-a250-d4ed2a56dd94",
        "embeds": [],
        "references": [
          "2fd5d952-9d65-4158-b3b6-875eb97ed27b"
        ],
        "dependson": [
          "d7bfd480-0b6d-4f91-b03b-b8b9d2a8490a"
        ]
      },
      "a03221d0-f68c-4b8d-80da-f21a49201aa3": {
        "size": {
          "width": 240,
          "height": 240
        },
        "position": {
          "x": 90,
          "y": 540
        },
        "z": 2,
        "parent": "c3b9f586-15d2-4534-ab1f-71f554d4f45c",
        "embeds": [
          "667898d4-359b-44ea-838a-08a339176711"
        ]
      },
      "667898d4-359b-44ea-838a-08a339176711": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 120,
          "y": 600
        },
        "z": 3,
        "parent": "a03221d0-f68c-4b8d-80da-f21a49201aa3",
        "embeds": [],
        "dependson": [
          "d7bfd480-0b6d-4f91-b03b-b8b9d2a8490a"
        ],
        "isrelatedto": [
          "eced61b2-b313-4f15-bbd8-f8a5ce15aaf1"
        ]
      },
      "fbee4fe9-ea2d-4e6e-b537-753c24e29cd5": {
        "size": {
          "width": 60,
          "height": 60
        },
        "position": {
          "x": 900,
          "y": 210
        },
        "z": 1,
        "embeds": [],
        "isconnectedto": [
          "667898d4-359b-44ea-838a-08a339176711"
        ],
        "dependson": [
          "d7bfd480-0b6d-4f91-b03b-b8b9d2a8490a"
        ]
      },
      "adc1fe1d-0dfc-4dbc-8af1-28bbff3d2827": {
        "source": {
          "id": "85fc77c5-4024-4568-b410-f5e54d28c01b"
        },
        "target": {
          "id": "a03221d0-f68c-4b8d-80da-f21a49201aa3"
        }
      },
      "80d3705b-398c-43a4-8c51-15a5242d41b4": {
        "source": {
          "id": "b91b7044-eb33-403c-a250-d4ed2a56dd94"
        },
        "target": {
          "id": "a03221d0-f68c-4b8d-80da-f21a49201aa3"
        }
      }
    }
  }
}
